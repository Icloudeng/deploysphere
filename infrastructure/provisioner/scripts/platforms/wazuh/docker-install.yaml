- name: Set vm.max_map_count runtime parameter
  ansible.posix.sysctl:
    name: vm.max_map_count
    value: "262144"
    state: present
    reload: yes

- name: Verify vm.max_map_count setting
  command: sysctl vm.max_map_count
  register: sysctl_output
  changed_when: "'262144' not in sysctl_output.stdout"

- name: Reboot the system if vm.max_map_count was not set
  reboot:
    msg: "Rebooting to apply vm.max_map_count changes"
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 60
  when: sysctl_output.changed

# Install Docker
- include_tasks: ../../tasks/docker.yaml

- set_fact:
    wazuh_path: "{{ project_path }}/repository"

- name: Clone Wazuh Docker repo from GitHub
  git:
    repo: "https://github.com/wazuh/wazuh-docker.git"
    dest: "{{ wazuh_path }}"
    version: "{{ wazuh_version }}"
    force: no
    update: no

- name: "Copy .env template"
  template:
    src: .env.j2
    dest: "{{ wazuh_path }}/single-node/.env"
    force: yes

- name: Generate self-signed certificates for each cluster node
  command: docker compose -f generate-indexer-certs.yml run --rm generator
  args:
    chdir: "{{ wazuh_path }}/single-node"
    creates: "{{ wazuh_path }}/single-node/config/wazuh_indexer_ssl_certs/root-ca.pem"

- name: Replace old INDEXER_PASSWORD
  ansible.builtin.replace:
    path: "{{ wazuh_path }}/single-node/docker-compose.yml"
    regexp: "INDEXER_PASSWORD=SecretPassword"
    replace: "INDEXER_PASSWORD={{ app_secret }}"
    backup: true
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: Replace old DASHBOARD_PASSWORD
  ansible.builtin.replace:
    path: "{{ wazuh_path }}/single-node/docker-compose.yml"
    regexp: "DASHBOARD_PASSWORD=kibanaserver"
    replace: "DASHBOARD_PASSWORD={{ app_secret }}"
    backup: true
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

# - name: Ensure lines containing INDEXER_PASSWORD or DASHBOARD_PASSWORD are absent
#   lineinfile:
#     path: "{{ wazuh_path }}/single-node/docker-compose.yml"
#     regexp: "^(.*)(INDEXER_PASSWORD|DASHBOARD_PASSWORD)(.*)$"
#     state: absent
#     backup: true

- name: Start the Wazuh single-node deployment
  command: "docker compose up -d --force-recreate"
  args:
    chdir: "{{ wazuh_path }}/single-node"

- set_fact:
    url_ping: "https://{{ vm_ip }}"

- name: Pause play until a URL is reachable from this host
  ignore_errors: true
  ansible.builtin.uri:
    url: "{{ url_ping }}"
    follow_redirects: none
    validate_certs: no
    method: GET
  register: _result
  until: _result.status >= 200
  retries: 30
  delay: 5

- set_fact:
    indexer_template: "https://raw.githubusercontent.com/wazuh/wazuh/{{ wazuh_version }}/extensions/elasticsearch/7.x/wazuh-template.json"

- name: Download Wazuh template and upload to Elasticsearch
  uri:
    url: "https://localhost:9200/_template/wazuh"
    method: PUT
    user: "admin"
    password: "{{ app_secret }}"
    body_format: json
    headers:
      Content-Type: "application/json"
    validate_certs: no
    status_code: [200, 201]
    force_basic_auth: yes
    body: "{{ lookup('ansible.builtin.url', indexer_template, wantlist=False, split_lines=False) }}"
